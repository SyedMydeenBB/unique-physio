{% extends 'base.html' %}
{% load static %}
{% block body_block %}

<div class="container-fluid py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center bg-white rounded shadow-sm px-4 py-3 mb-4">
    <h4 class="fw-semibold text-primary mb-0">Patient Management</h4>
    <div id="datetime" class="text-muted small"></div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="action-buttons mb-4">
    <a href="{% url 'patient_create' %}" class="btn btn-primary">
      <i class="fas fa-user-plus"></i> Add New Patient
    </a>
    <a href="{% url 'upload_excel' %}" class="btn btn-info">
      <i class="fas fa-file-upload"></i> Upload Excel
    </a>
    <a href="{% url 'download_excel' %}" class="btn btn-warning">
      <i class="fas fa-file-download"></i> Download Excel
    </a>
  </div>

  <!-- FILTER SECTION -->
  <div class="card shadow border-0 mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-filter me-2"></i> Search & Filter Patients
      </h5>
    </div>
    <div class="card-body">
      <form method="get" id="filterForm">
        <div class="row g-3">
          <!-- Case Number -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Case Number</label>
            {{ filter_form.case_number }}
          </div>

          <!-- Name -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Patient Name</label>
            {{ filter_form.name }}
          </div>

          <!-- Gender -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Gender</label>
            {{ filter_form.gender }}
          </div>

          <!-- Year -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Registration Year</label>
            {{ filter_form.year }}
          </div>

          <!-- Date From -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Date From</label>
            {{ filter_form.date_from }}
          </div>

          <!-- Date To -->
          <div class="col-lg-3 col-md-6">
            <label class="form-label fw-semibold">Date To</label>
            {{ filter_form.date_to }}
          </div>

          <!-- Buttons -->
          <div class="col-lg-6 col-md-12 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search me-1"></i> Apply Filters
            </button>
            <a href="{% url 'patient_list' %}" class="btn btn-secondary">
              <i class="fas fa-redo me-1"></i> Clear All
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- TABLE CONTAINER -->
  <div class="card shadow border-0">

    <!-- CARD HEADER -->
 <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom">
  <h5 class="text-primary mb-0 fw-semibold">
    <i class="fas fa-users me-2"></i>
    All Patients ({{ total_count }} Patients)
  </h5>
</div>


    <!-- TABLE -->
<div class="card-body p-0">
  <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Case No</th>
          <th>Age</th>
          <th>Gender</th>
          <th>Cheif Complaint</th>
          <th>Reference</th>
          <th>Contact</th>
          <th>Address</th>
          <th>Registered On</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for patient in records %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td class="fw-semibold">{{ patient.name }}</td>
          <td><span class="badge bg-info">{{ patient.case_number }}</span></td>
          <td>{{ patient.age }}</td>
          <td>{{ patient.get_gender_display }}</td>
          <td>{{ patient.chief_complaint|truncatewords:5 }}</td>
          <td>{{ patient.reference|default:"-" }}</td>
          <td>{{ patient.contact|default:"-" }}</td>
          <td>{{ patient.address|default:"-" }}</td>
          <td><small>{{ patient.created_at|date:"d M Y" }}</small></td>
          <td class="text-center">
            <div class="btn-group btn-group-sm">
              <a href="{% url 'patient_update' patient.id %}" class="btn btn-outline-primary">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{% url 'patient_delete' patient.id %}" class="btn btn-outline-danger btn-delete">
                <i class="bi bi-trash"></i>
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="10" class="text-center py-5">
            <i class="fas fa-user-injured fa-2x text-muted mb-2"></i>
            <p class="mb-0 text-muted">No patients found</p>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


    <!-- PAGINATION
    {% if patients.has_other_pages %}
    <div class="card-footer bg-white">
      <nav>
        <ul class="pagination justify-content-end mb-0">
          {% if patients.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ patients.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
          </li>
          {% endif %}

          {% for num in patients.paginator.page_range %}
            {% if patients.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > patients.number|add:'-2' and num < patients.number|add:'2' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if patients.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ patients.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %} -->
  </div>

  <!-- FOOTER -->
  <div class="text-center text-muted small mt-4">
    Â© 2025 Unique Physio Care. All Rights Reserved.
  </div>

</div>

<!-- SCRIPT -->
<script>
  function updateDateTime() {
    const now = new Date();
    document.getElementById("datetime").innerText =
      now.toLocaleDateString() + " | " + now.toLocaleTimeString();
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', e => {
      if (!confirm('Are you sure you want to delete this patient?')) {
        e.preventDefault();
      }
    });
  });
</script>

{% endblock %}

