{% extends 'base.html' %}
{% load static %}
{% block body_block %}

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center bg-white rounded shadow-sm px-4 py-3 mb-4">
    <h4 class="fw-semibold text-primary mb-0">PC List Management</h4>
    <div id="datetime" class="text-muted small"></div>
  </div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item">
    <button
      type="button"
      class="nav-link active"
      data-bs-toggle="tab"
      data-bs-target="#addPC"
      role="tab">
      Add Patient
    </button>
  </li>

  <li class="nav-item">
    <button
      type="button"
      class="nav-link"
      id="followup-tab"
      data-bs-toggle="tab"
      data-bs-target="#followup"
      role="tab">
      Patient Follow-up
    </button>
  </li>
</ul>

<div class="tab-content">

<!-- ================= TAB 1 ================= -->
<div class="tab-pane fade show active" id="addPC" role="tabpanel">

<form method="post">
{% csrf_token %}
{{ form.patient_id.as_hidden }}

<!-- BASIC INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-id-card me-2"></i> Basic Information
  </h6>

  <div class="row g-4">
    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Date</label>
      {{ form.date }}
    </div>

    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Case Number *</label>
      {{ form.case_number }}
    </div>

    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Name *</label>
      {{ form.name }}
    </div>

   <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Diagnosis *</label>
      {{ form.diagnosis }}
    </div>
  </div>
</div>


<!-- PAYMENT INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-rupee-sign me-2"></i> Payment Information
  </h6>

  <div class="row g-4">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Charge</label>
      {{ form.charge }}
    </div>

    <div class="col-md-4">
      <label class="form-label fw-semibold">Received</label>
      {{ form.received }}
    </div>

    <div class="col-md-4">
      <label class="form-label fw-semibold">Payment Status</label>
      {{ form.payment_status }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Payment Type</label>
      {{ form.payment_type }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Payment Frequency</label>
      {{ form.payment_frequency }}
    </div>
  </div>
</div>

<!-- TIME INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-clock me-2"></i> Time Information
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold">In Time</label>
      {{ form.in_time }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Out Time</label>
      {{ form.out_time }}
    </div>
  </div>
</div>

<!-- TREATMENT DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-notes-medical me-2"></i> Treatment Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">{{ form.treatment_1 }}</div>
    <div class="col-md-6">{{ form.treatment_2 }}</div>
    <div class="col-md-6">{{ form.treatment_3 }}</div>
    <div class="col-md-6">{{ form.treatment_4 }}</div>
  </div>
</div>


<!-- THERAPIST DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-user-nurse me-2"></i> Therapist Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold">Therapist 1</label>
      {{ form.therapist_1 }}
    </div>
{% comment %} 
    <div class="col-md-6">
      <label class="form-label fw-semibold">Therapist 2</label>
      {{ form.therapist_2 }}
    </div> {% endcomment %}
  </div>
</div>
<!-- THERAPIST DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-user-nurse me-2"></i> Follow-up Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold"> Treatment Protocol</label>
      {{ form.explain_treatment }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Feedback</label>
      {{ form.feedback }}
    </div>
  </div>
</div>
<div class="d-flex justify-content-end gap-3 border-top pt-4">
  <a href="{% url 'pc_list_list' %}" class="btn btn-secondary px-4">Cancel</a>
  <button type="submit" class="btn btn-primary px-4">Save Entry</button>
</div>

</form>
</div>

<!-- ================= TAB 2 ================= -->
<div class="tab-pane fade" id="followup" role="tabpanel">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Patient Follow-up Details</h4>
  <button id="downloadPdfBtn" class="btn btn-success" disabled>
    <i class="fas fa-download me-2"></i>Download as PDF
  </button>
</div>

<div class="card p-3 mb-3">
  <h5>Patient Details</h5>
  <p><strong>Name:</strong> <span id="f_name"></span></p>
  <p><strong>Case No:</strong> <span id="f_case"></span></p>
  <p><strong>Age:</strong> <span id="f_age"></span></p>
  <p><strong>Gender:</strong> <span id="f_gender"></span></p>
  <p><strong>Diagnosis:</strong> <span id="f_diagnosis"></span></p>
</div>

<div class="table-responsive">
  <table class="table table-bordered" id="followupTable">
    <thead>
      <tr>
        <th style="width: 15%">Date</th>
        <th style="width: 40%">Feedback</th>
        <th style="width: 40%">Treatment</th>
      </tr>
    </thead>
    <tbody id="followupBody"></tbody>
  </table>
</div>

</div>
</div>
</div>

<!-- [Scripts identical to daily_sheet_form.html but with PC-specific changes] -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let patientId = null;
    let patientName = "";
    let caseNumber = "";
    const currentTime = new Date().toTimeString().slice(0, 5);

    const caseInput = document.getElementById("id_case_number");
    const paymentStatusInput = document.getElementById("id_payment_status");
    const followupTab = document.getElementById("followup-tab");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");

    // Auto-fill in_time when case number is entered
    if (caseInput) {
        caseInput.addEventListener("blur", function () {
            if (this.value && !document.getElementById("id_in_time").value) {
                document.getElementById("id_in_time").value = currentTime;
            }

            if (!this.value) return;

          fetch(`/ajax/check-pc-number/?case_number=${this.value}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById("id_name").value = data.name;
                    document.getElementById("id_diagnosis").value = data.diagnosis;
                    document.getElementById("id_patient_id").value = data.patient_id;

                    patientId = data.patient_id;
                    patientName = data.name;
                    caseNumber = this.value;

                    document.getElementById("f_name").innerText = data.name;
                    document.getElementById("f_case").innerText = this.value;
                    document.getElementById("f_age").innerText = data.age;
                    document.getElementById("f_gender").innerText = data.gender;
                    document.getElementById("f_diagnosis").innerText = data.diagnosis;
                    
                    downloadPdfBtn.disabled = false;
                } else {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert("Patient not found. Create the patient first.");
                    }
                    
                    document.getElementById("id_name").value = "";
                    document.getElementById("id_diagnosis").value = "";
                    document.getElementById("id_patient_id").value = "";
                    
                    patientId = null;
                    patientName = "";
                    caseNumber = "";
                    
                    document.getElementById("f_name").innerText = "";
                    document.getElementById("f_case").innerText = "";
                    document.getElementById("f_age").innerText = "";
                    document.getElementById("f_gender").innerText = "";
                    document.getElementById("f_diagnosis").innerText = "";
                    document.getElementById("followupBody").innerHTML = "";
                    
                    downloadPdfBtn.disabled = true;
                }
            });
        });
    }

// Auto-fill out_time when payment status is changed
    if (paymentStatusInput) {
        paymentStatusInput.addEventListener("change", function () {
            if (this.value && this.value !== "" && !document.getElementById("id_out_time").value) {
                document.getElementById("id_out_time").value = currentTime;
            }
        });
    }

    if (followupTab) {
        followupTab.addEventListener("click", function () {
            if (!patientId) return;

            fetch(`/ajax/patient-pc-followups/${patientId}/`)
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.data.forEach(row => {
                    html += `
                    <tr>
                      <td>${row.date}</td>
                      <td class="text-wrap">${row.feedback || ''}</td>
                      <td class="text-wrap">${row.explain_treatment || ''}</td>
                      
                    </tr>`;
                });
                document.getElementById("followupBody").innerHTML = html;
            });
        });
    }

    // PDF Download functionality
    downloadPdfBtn.addEventListener("click", function() {
        if (!patientId) {
            alert("Please select a patient first");
            return;
        }

        // Generate PDF filename
        const filename = `${patientName.replace(/\s+/g, '_')}_${caseNumber}_Followup.pdf`;
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        
       // Add watermark
        {% comment %}  doc.setFontSize(70);
        doc.setTextColor(200, 200, 200);
        doc.setFont("helvetica", "normal");
        // Center watermark both horizontally and vertically
        doc.text("Unique Physio and Rehabilitation Center", 
                pageWidth / 2, 
                pageHeight / 2, 
                { align: 'center', baseline: 'middle', angle: 45 }); {% endcomment %}
        
        // Reset text color and font
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        
        // Add header
        doc.setFontSize(20);
        doc.setFont("helvetica", "bold");
        doc.text("PATIENT FOLLOW-UP DETAILS", pageWidth / 2, 25, { align: 'center' });
        
        // Draw header line
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        doc.line(20, 30, pageWidth - 20, 30);
        
        // Add patient information
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        let yPos = 40;
        
        doc.text("PATIENT INFORMATION:", 20, yPos);
        yPos += 10;
        
        doc.setFont("helvetica", "normal");
        doc.text(`Name: ${patientName}`, 25, yPos);
        yPos += 7;
        doc.text(`Case Number: ${caseNumber}`, 25, yPos);
        yPos += 7;
        doc.text(`Age: ${document.getElementById("f_age").innerText}`, 25, yPos);
        yPos += 7;
        doc.text(`Gender: ${document.getElementById("f_gender").innerText}`, 25, yPos);
        yPos += 7;
        doc.text(`Diagnosis: ${document.getElementById("f_diagnosis").innerText}`, 25, yPos);
        
        yPos += 15;
        
        // Add follow-up section header
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("FOLLOW-UP RECORDS", 20, yPos);
        yPos += 10;
        
        // Add follow-up records
        doc.setFontSize(12);
        const tableBody = document.getElementById("followupBody");
        const rows = tableBody.getElementsByTagName("tr");
        
        if (rows.length === 0) {
            doc.setFont("helvetica", "normal");
            doc.text("No follow-up records found.", 20, yPos);
            yPos += 10;
        } else {
            for (let rowIndex = 0; rowIndex < rows.length; rowIndex++) {
                const row = rows[rowIndex];
                const cells = row.getElementsByTagName("td");
                
                if (cells.length >= 3) {
                    const date = cells[0].innerText || '';
                    const treatment = cells[2].innerText || '';
                    const feedback = cells[1].innerText || '';
                    
                    // Calculate required height for this record
                    const treatmentLines = doc.splitTextToSize(treatment, pageWidth - 60);
                    const feedbackLines = doc.splitTextToSize(feedback, pageWidth - 60);
                    const recordHeight = 8 + 5 + treatmentLines.length * 5 + 3 + 5 + feedbackLines.length * 5 + 10;
                    
                    // Check for page break
                    if (yPos + recordHeight > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                        
                        // Add watermark to new page
                        doc.setFontSize(60);
                        doc.setTextColor(200, 200, 200);
                        // Center watermark both horizontally and vertically
                        doc.text("Unique Physio and Rehabilitation Center", 
                                pageWidth / 2, 
                                pageHeight / 2, 
                                { align: 'center', baseline: 'middle', angle: 45 });
                        doc.setTextColor(0, 0, 0);
                        
                        // Add follow-up section header on new page
                        doc.setFont("helvetica", "bold");
                        doc.setFontSize(16);
                        doc.text("FOLLOW-UP RECORDS (Continued)", 20, yPos);
                        yPos += 10;
                    }
                    
                    // Save the starting position for the record
                    const recordStartY = yPos;
                    
                    // Add record container with border
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.rect(15, recordStartY - 5, pageWidth - 30, recordHeight);
                    
                    // Add date with background
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, recordStartY - 5, pageWidth - 30, 8, 'F');
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Date: ${date}`, 20, recordStartY);
                    yPos += 10;
                    
                    // Add treatment explanation
                    doc.setFont("helvetica", "bold");
                    doc.text("Treatment Explanation:", 20, yPos);
                    yPos += 5;
                    doc.setFont("helvetica", "normal");
                    
                    // Add treatment text
                    for (let i = 0; i < treatmentLines.length; i++) {
                        doc.text(treatmentLines[i], 20, yPos);
                        yPos += 5;
                    }
                    
                    // Add feedback
                    yPos += 3;
                    doc.setFont("helvetica", "bold");
                    doc.text("Feedback:", 20, yPos);
                    yPos += 5;
                    doc.setFont("helvetica", "normal");
                    
                    // Add feedback text
                    for (let i = 0; i < feedbackLines.length; i++) {
                        doc.text(feedbackLines[i], 20, yPos);
                        yPos += 5;
                    }
                    
                    // Add space between records
                    yPos += 10;
                }
            }
        }
        
        // Add footer
        doc.setFontSize(10);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(100, 100, 100);
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        doc.text(`Report generated on: ${dateStr}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
        
        // Add page numbers
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text(`Page ${i} of ${totalPages}`, pageWidth - 20, pageHeight - 10);
        }
        
        // Save PDF
        doc.save(filename);
    });
});
function updateDateTime() {
  const now = new Date();
  document.getElementById("datetime").innerText =
    now.toLocaleDateString() + " | " + now.toLocaleTimeString();
}
setInterval(updateDateTime, 1000);
updateDateTime();

</script>

{% endblock %}