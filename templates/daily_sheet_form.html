{% extends 'base.html' %}
{% load static %}
{% block body_block %}

<div class="container-fluid py-4">

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item">
    <button
      type="button"
      class="nav-link active"
      data-bs-toggle="tab"
      data-bs-target="#addSheet"
      role="tab">
      Add Daily Sheet
    </button>
  </li>

  <li class="nav-item">
    <button
      type="button"
      class="nav-link"
      id="followup-tab"
      data-bs-toggle="tab"
      data-bs-target="#followup"
      role="tab">
      Patient Follow-up
    </button>
  </li>
</ul>

<div class="tab-content">

<!-- ================= TAB 1 ================= -->
<div class="tab-pane fade show active" id="addSheet" role="tabpanel">

<form method="post">
{% csrf_token %}
{{ form.patient_id.as_hidden }}

<!-- BASIC INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-id-card me-2"></i> Basic Information
  </h6>

  <div class="row g-4">
    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Date</label>
      {{ form.date }}
    </div>

    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Case Number *</label>
      {{ form.case_number }}
    </div>

    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Name *</label>
      {{ form.name }}
    </div>

    <div class="col-lg-3 col-md-6">
      <label class="form-label fw-semibold">Diagnosis *</label>
      {{ form.diagnosis }}
    </div>
  </div>
</div>

<!-- PAYMENT INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-rupee-sign me-2"></i> Payment Information
  </h6>

  <div class="row g-4">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Charge</label>
      {{ form.charge }}
    </div>

    <div class="col-md-4">
      <label class="form-label fw-semibold">Received</label>
      {{ form.received }}
    </div>

    <div class="col-md-4">
      <label class="form-label fw-semibold">Payment Status</label>
      {{ form.payment_status }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Payment Type</label>
      {{ form.payment_type }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Payment Frequency</label>
      {{ form.payment_frequency }}
    </div>
  </div>
</div>

<!-- TIME INFORMATION -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-clock me-2"></i> Time Information
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold">In Time</label>
      {{ form.in_time }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Out Time</label>
      {{ form.out_time }}
    </div>
  </div>
</div>

<!-- TREATMENT DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-notes-medical me-2"></i> Treatment Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">{{ form.treatment_1 }}</div>
    <div class="col-md-6">{{ form.treatment_2 }}</div>
    <div class="col-md-6">{{ form.treatment_3 }}</div>
    <div class="col-md-6">{{ form.treatment_4 }}</div>
  </div>
</div>


<!-- THERAPIST DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-user-nurse me-2"></i> Therapist Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold">Therapist 1</label>
      {{ form.therapist_1 }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Therapist 2</label>
      {{ form.therapist_2 }}
    </div>
  </div>
</div>
<!-- THERAPIST DETAILS -->
<div class="bg-light rounded border-start border-4 border-primary p-4 mb-4">
  <h6 class="fw-semibold text-primary mb-3">
    <i class="fas fa-user-nurse me-2"></i> Follow-up Details
  </h6>

  <div class="row g-4">
    <div class="col-md-6">
      <label class="form-label fw-semibold">Explain Treatment</label>
      {{ form.explain_treatment }}
    </div>

    <div class="col-md-6">
      <label class="form-label fw-semibold">Feedback</label>
      {{ form.feedback }}
    </div>
  </div>
</div>

<div class="d-flex justify-content-end gap-3 border-top pt-4">
  <a href="{% url 'daily_sheet_list' %}" class="btn btn-secondary px-4">Cancel</a>
  <button type="submit" class="btn btn-primary px-4">Save Entry</button>
</div>

</form>
</div>

<!-- ================= TAB 2 ================= -->
<div class="tab-pane fade" id="followup" role="tabpanel">

<div class="card p-3 mb-3">
  <h5>Patient Details</h5>
  <p><strong>Name:</strong> <span id="f_name"></span></p>
  <p><strong>Case No:</strong> <span id="f_case"></span></p>
  <p><strong>Age:</strong> <span id="f_age"></span></p>
  <p><strong>Gender:</strong> <span id="f_gender"></span></p>
  <p><strong>Diagnosis:</strong> <span id="f_diagnosis"></span></p>
</div>

<div class="table-responsive">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th style="width: 15%">Date</th>
        <th style="width: 40%">Treatment Explanation</th>
        <th style="width: 40%">Feedback</th>
      </tr>
    </thead>
    <tbody id="followupBody"></tbody>
  </table>
</div>

</div>
</div>
</div>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    let patientId = null;
    const currentTime = new Date().toTimeString().slice(0, 5);

    const caseInput = document.getElementById("id_case_number");
    const paymentStatusInput = document.getElementById("id_payment_status");
    const followupTab = document.getElementById("followup-tab");

    // Auto-fill in_time when case number is entered
    if (caseInput) {
        caseInput.addEventListener("blur", function () {
            if (this.value && !document.getElementById("id_in_time").value) {
                document.getElementById("id_in_time").value = currentTime;
            }

            if (!this.value) return;

            fetch(`/ajax/check-case-number/?case_number=${this.value}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById("id_name").value = data.name;
                    document.getElementById("id_diagnosis").value = data.diagnosis;
                    document.getElementById("id_patient_id").value = data.patient_id;

                    patientId = data.patient_id;

                    document.getElementById("f_name").innerText = data.name;
                    document.getElementById("f_case").innerText = this.value;
                    document.getElementById("f_age").innerText = data.age;
                    document.getElementById("f_gender").innerText = data.gender;
                    document.getElementById("f_diagnosis").innerText = data.diagnosis;
                }
            });
        });
    }

    // Auto-fill out_time when payment status is changed
    if (paymentStatusInput) {
        paymentStatusInput.addEventListener("change", function () {
            if (this.value && this.value !== "" && !document.getElementById("id_out_time").value) {
                document.getElementById("id_out_time").value = currentTime;
            }
        });
    }

    if (followupTab) {
        followupTab.addEventListener("click", function () {
            if (!patientId) return;

            fetch(`/ajax/patient-followups/${patientId}/`)
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.data.forEach(row => {
                    html += `
                    <tr>
                      <td>${row.date}</td>
                      <td class="text-wrap">${row.explain_treatment || ''}</td>
                      <td class="text-wrap">${row.feedback || ''}</td>
                    </tr>`;
                });
                document.getElementById("followupBody").innerHTML = html;
            });
        });
    }

});
</script>

{% endblock %}